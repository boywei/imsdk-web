{"remainingRequest":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/babel-loader/lib/index.js!/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/src/components/message/merger-message/mergerMessage-item.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/src/components/message/merger-message/mergerMessage-item.vue","mtime":1648707124000},{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/babel.config.js","mtime":1648707124000},{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport _defineProperty from \"/Users/wei/IdeaProjects/boywei/imsdk-web/Demo/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty.js\";\nimport _Rate2 from \"element-ui/lib/theme-chalk/rate.css\";\nimport \"element-ui/lib/theme-chalk/base.css\";\nimport _Rate from \"element-ui/lib/rate\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { mapState } from 'vuex';\nimport { decodeText } from \"../../../utils/decodeText\";\nimport { getFullDate } from \"../../../utils/date\";\nexport default {\n  name: 'MessageItem',\n  props: {\n    message: {\n      type: Object,\n      required: true\n    },\n    payload: {\n      type: Object,\n      required: true\n    }\n  },\n  components: {\n    ElRate: _Rate\n  },\n  data: function data() {\n    return {\n      renderDom: [],\n      showConversationList: false,\n      relayMessage: {},\n      selectedConversation: [],\n      messageSelected: []\n    };\n  },\n  computed: _objectSpread(_objectSpread({}, mapState({\n    currentConversation: function currentConversation(state) {\n      return state.conversation.currentConversation;\n    },\n    currentUserProfile: function currentUserProfile(state) {\n      return state.user.currentUserProfile;\n    },\n    isShowConversationList: function isShowConversationList(state) {\n      return state.conversation.isShowConversationList;\n    }\n  })), {}, {\n    // 自定义消息\n    rate: function rate() {\n      return parseInt(this.payload.description);\n    },\n    // 图片消息\n    imageUrl: function imageUrl() {\n      var url = this.payload.imageInfoArray[0].imageUrl;\n\n      if (typeof url !== 'string') {\n        return '';\n      }\n\n      return url.slice(0, 2) === '//' ? \"https:\".concat(url) : url;\n    },\n    // showProgressBar() {\n    //   return this.$parent.message.status === 'unSend'\n    // },\n    percentage: function percentage() {\n      return Math.floor((this.$parent.message.progress || 0) * 100);\n    },\n    // 表情消息\n    faceUrl: function faceUrl() {\n      var name = '';\n\n      if (this.payload.data.indexOf('@2x') > 0) {\n        name = this.payload.data;\n      } else {\n        name = this.payload.data + '@2x';\n      }\n\n      return \"https://web.sdk.qcloud.com/im/assets/face-elem/\".concat(name, \".png\");\n    },\n    // 时间换算\n    date: function date() {\n      return getFullDate(new Date(this.message.time * 1000));\n    },\n    // 文件消息大小\n    fileSize: function fileSize() {\n      var size = this.payload.fileSize;\n\n      if (size > 1024) {\n        if (size / 1024 > 1024) {\n          return \"\".concat(this.toFixed(size / 1024 / 1024), \" Mb\");\n        }\n\n        return \"\".concat(this.toFixed(size / 1024), \" Kb\");\n      }\n\n      return \"\".concat(this.toFixed(size), \"B\");\n    },\n    // 消息昵称\n    from: function from() {\n      var isC2C = this.currentConversation.type === this.TIM.TYPES.CONV_C2C; // 自己发送的用昵称渲染\n\n      if (this.isMine) {\n        return this.currentUserProfile.nick || this.currentUserProfile.userID;\n      } // 1. C2C 的消息体中还无 nick / avatar 字段，需从 conversation.userProfile 中获取\n\n\n      if (isC2C) {\n        return this.currentConversation.userProfile.nick || this.currentConversation.userProfile.userID;\n      } // 2. 群组消息，用消息体中的 nick 渲染。nameCard暂时支持不完善\n\n\n      return this.message.nameCard || this.message.nick || this.message.from;\n    },\n    avatar: function avatar() {\n      if (this.currentConversation.type === 'C2C') {\n        return this.isMine ? this.currentUserProfile.avatar : this.currentConversation.userProfile.avatar;\n      } else if (this.currentConversation.type === 'GROUP') {\n        return this.isMine ? this.currentUserProfile.avatar : this.message.avatar;\n      } else {\n        return '';\n      }\n    },\n    currentConversationType: function currentConversationType() {\n      return this.currentConversation.type;\n    },\n    isMine: function isMine() {\n      return this.message.flow === 'out';\n    },\n    contentList: function contentList() {\n      return decodeText(this.payload);\n    }\n  }),\n  methods: {\n    // 自定义消息解析\n    translateCustomMessage: function translateCustomMessage(payload) {\n      var videoPayload = {};\n\n      try {\n        videoPayload = JSON.parse(payload.data);\n      } catch (e) {\n        videoPayload = {};\n      }\n\n      if (payload.data === 'group_create') {\n        return \"\".concat(payload.extension);\n      }\n\n      if (videoPayload.roomId) {\n        videoPayload.roomId = videoPayload.roomId.toString();\n        videoPayload.isFromGroupLive = 1;\n        return videoPayload;\n      }\n\n      if (payload.text) {\n        return payload.text;\n      } else {\n        return '[自定义消息]';\n      }\n    },\n    // 图片消息\n    onImageLoaded: function onImageLoaded(event) {\n      this.$bus.$emit('image-loaded', event);\n    },\n    handlePreview: function handlePreview() {\n      this.$bus.$emit('image-preview', {\n        url: this.payload.imageInfoArray[0].url,\n        flag: true\n      });\n    },\n    toFixed: function toFixed(number) {\n      var precision = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 2;\n      return number.toFixed(precision);\n    },\n    showGroupMemberProfile: function showGroupMemberProfile(event) {\n      var _this = this;\n\n      this.tim.getGroupMemberProfile({\n        groupID: this.message.to,\n        userIDList: [this.message.from]\n      }).then(function (_ref) {\n        var memberList = _ref.data.memberList;\n\n        if (memberList[0]) {\n          _this.$bus.$emit('showMemberProfile', {\n            event: event,\n            member: memberList[0]\n          });\n        }\n      });\n    },\n    messageClick: function messageClick(message) {\n      this.$store.commit('showConversationList', false);\n      this.showConversationList = true;\n      this.relayMessage = message; // 需要深拷贝吗？\n    },\n    showMergerMessage: function showMergerMessage() {\n      this.$bus.$emit('mergerMessage', true);\n    },\n    cancel: function cancel() {\n      this.showConversationList = false;\n    },\n    getList: function getList(value) {\n      this.selectedConversation = value;\n    },\n    messageRelay: function messageRelay() {\n      var _this2 = this;\n\n      var type = '';\n      var toUserId = '';\n      this.selectedConversation.forEach(function (item) {\n        if (item.indexOf(_this2.TIM.TYPES.CONV_C2C) !== -1) {\n          type = _this2.TIM.TYPES.CONV_C2C;\n          toUserId = item.substring(3, item.length);\n        }\n\n        if (item.indexOf(_this2.TIM.TYPES.CONV_GROUP) !== -1) {\n          type = _this2.TIM.TYPES.CONV_GROUP;\n          toUserId = item.substring(5, item.length);\n        }\n\n        var message = _this2.tim.createForwardMessage({\n          to: toUserId,\n          conversationType: type,\n          payload: _this2.relayMessage,\n          priority: _this2.TIM.TYPES.MSG_PRIORITY_NORMAL\n        });\n\n        _this2.tim.sendMessage(message).catch(function (imError) {\n          _this2.$store.commit('showMessage', {\n            message: imError.message,\n            type: 'error'\n          });\n        });\n\n        _this2.showConversationList = false;\n      });\n    },\n    // 合并的消息\n    mergerHandler: function mergerHandler(message) {\n      this.$store.commit('setMergerMessage', message); // this.$bus.$emit('mergerMessage', message)\n    },\n    // 视频消息\n    videoError: function videoError(e) {\n      this.$store.commit('showMessage', {\n        type: 'error',\n        message: '视频出错，错误原因：' + e.target.error.message\n      });\n    },\n    // 音频消息\n    play: function play() {\n      // 目前移动端的语音消息采用 aac 格式，以前用 amr 格式。默认先用 audio 标签播放，若无法播放则尝试 amr 格式播放。\n      var audio = document.createElement('audio');\n      audio.addEventListener('error', this.tryPlayAMR); // 播放出错，则尝试使用 AMR 播放\n\n      audio.src = this.payload.url;\n      var promise = audio.play();\n\n      if (promise) {\n        promise.catch(function () {});\n      }\n    },\n    tryPlayAMR: function tryPlayAMR() {\n      try {\n        var isIE = /MSIE|Trident|Edge/.test(window.navigator.userAgent); // amr 播放组件库在 IE 不支持\n\n        if (isIE) {\n          this.$store.commit('showMessage', {\n            message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n            type: 'warning'\n          });\n          return;\n        } // 动态插入 amr 播放组件库\n\n\n        if (!window.BenzAMRRecorder) {\n          var script = document.createElement('script');\n          script.addEventListener('load', this.playAMR);\n          script.src = './BenzAMRRecorder.js';\n          var firstScript = document.getElementsByTagName('script')[0];\n          firstScript.parentNode.insertBefore(script, firstScript);\n          return;\n        }\n\n        this.playAMR();\n      } catch (error) {\n        this.$store.commit('showMessage', {\n          message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n          type: 'warning'\n        });\n      }\n    },\n    playAMR: function playAMR() {\n      var _this3 = this;\n\n      if (!this.amr && window.BenzAMRRecorder) {\n        this.amr = new window.BenzAMRRecorder();\n      }\n\n      if (this.amr.isInit()) {\n        this.amr.play();\n        return;\n      }\n\n      this.amr.initWithUrl(this.url).then(function () {\n        _this3.amr.play();\n      });\n    },\n    // 文件消息\n    downloadFile: function downloadFile() {\n      var _this4 = this;\n\n      // 浏览器支持fetch则用blob下载，避免浏览器点击a标签，跳转到新页面预览的行为\n      if (window.fetch) {\n        fetch(this.payload.fileUrl).then(function (res) {\n          return res.blob();\n        }).then(function (blob) {\n          var a = document.createElement('a');\n          var url = window.URL.createObjectURL(blob);\n          a.href = url;\n          a.download = _this4.payload.fileName;\n          a.click();\n        });\n      } else {\n        var a = document.createElement('a');\n        a.href = this.payload.fileUrl;\n        a.target = '_blank';\n        a.download = this.filename;\n        a.click();\n      }\n    }\n  }\n};",{"version":3,"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+EA;AACA;AACA;AAGA;AACAA,qBADA;AAEAC;AACAC;AACAC,kBADA;AAEAC;AAFA,KADA;AAKAC;AACAF,kBADA;AAEAC;AAFA;AALA,GAFA;AAaAE;AACAC;AADA,GAbA;AAgBAC,MAhBA,kBAgBA;AACA;AACAC,mBADA;AAEAC,iCAFA;AAGAC,sBAHA;AAIAC,8BAJA;AAKAC;AALA;AAOA,GAxBA;AAyBAC,4CACAC;AACAC;AAAA;AAAA,KADA;AAEAC;AAAA;AAAA,KAFA;AAGAC;AAAA;AAAA;AAHA,IADA;AAOA;AACAC,QARA,kBAQA;AACA;AACA,KAVA;AAWA;AACAC,YAZA,sBAYA;AACA;;AACA;AACA;AACA;;AACA;AACA,KAlBA;AAmBA;AACA;AACA;AACAC,cAtBA,wBAsBA;AACA;AACA,KAxBA;AAyBA;AACAC,WA1BA,qBA0BA;AACA;;AACA;AACAtB;AACA,OAFA,MAEA;AACAA;AACA;;AACA;AACA,KAlCA;AAmCA;AACAuB,QApCA,kBAoCA;AACA;AACA,KAtCA;AAwCA;AACAC,YAzCA,sBAyCA;AACA;;AACA;AACA;AACA;AACA;;AACA;AACA;;AACA;AACA,KAlDA;AAmDA;AACAC,QApDA,kBAoDA;AACA,4EADA,CAEA;;AACA;AACA;AACA,OALA,CAMA;;;AACA;AACA,eACA,6CACA,2CAFA;AAIA,OAZA,CAaA;;;AACA;AACA,KAnEA;AAoEAC,UApEA,oBAoEA;AACA;AACA,6BACA,8BADA,GAEA,2CAFA;AAGA,OAJA,MAIA;AACA,6BACA,8BADA,GAEA,mBAFA;AAGA,OAJA,MAIA;AACA;AACA;AACA,KAhFA;AAiFAC,2BAjFA,qCAiFA;AACA;AACA,KAnFA;AAoFAC,UApFA,oBAoFA;AACA;AACA,KAtFA;AAuFAC,eAvFA,yBAuFA;AACA;AACA;AAzFA,IAzBA;AAoHAC;AACA;AACAC,0BAFA,kCAEA1B,OAFA,EAEA;AACA;;AACA;AACA2B;AACA,OAFA,CAEA;AACAA;AACA;;AACA;AACA;AACA;;AACA;AACAA;AACAA;AACA;AACA;;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA;AACA,KAtBA;AAuBA;AACAC,iBAxBA,yBAwBAC,KAxBA,EAwBA;AACA;AACA,KA1BA;AA2BAC,iBA3BA,2BA2BA;AACA;AACAC,+CADA;AAEAC;AAFA;AAIA,KAhCA;AAiCAC,WAjCA,mBAiCAC,MAjCA,EAiCA;AAAA;AACA;AACA,KAnCA;AAoCAC,0BApCA,kCAoCAN,KApCA,EAoCA;AAAA;;AACA,eACAO,qBADA,CACA;AACAC,gCADA;AAEAC;AAFA,OADA,EAKAC,IALA,CAKA;AAAA;;AACA;AACA;AAAAV;AAAAW;AAAA;AACA;AACA,OATA;AAUA,KA/CA;AAgDAC,gBAhDA,wBAgDA5C,OAhDA,EAgDA;AACA;AACA;AACA,kCAHA,CAGA;AACA,KApDA;AAqDA6C,qBArDA,+BAqDA;AACA;AACA,KAvDA;AAwDAC,UAxDA,oBAwDA;AACA;AACA,KA1DA;AA2DAC,WA3DA,mBA2DAC,KA3DA,EA2DA;AACA;AACA,KA7DA;AA8DAC,gBA9DA,0BA8DA;AAAA;;AACA;AACA;AACA;AACA;AACAhD;AACAiD;AACA;;AACA;AACAjD;AACAiD;AACA;;AACA;AACAC,sBADA;AAEAC,gCAFA;AAGAjD,sCAHA;AAIAkD;AAJA;;AAMA;AACA;AACArD,oCADA;AAEAC;AAFA;AAIA,SALA;;AAMA;AACA,OAtBA;AAuBA,KAxFA;AAyFA;AACAqD,iBA1FA,yBA0FAtD,OA1FA,EA0FA;AACA,sDADA,CAEA;AACA,KA7FA;AA8FA;AACAuD,cA/FA,sBA+FAC,CA/FA,EA+FA;AACA;AAAAvD;AAAAD;AAAA;AACA,KAjGA;AAkGA;AACAyD,QAnGA,kBAmGA;AACA;AACA;AACAC,uDAHA,CAGA;;AACAA;AACA;;AACA;AACAC;AACA;AACA,KA5GA;AA6GAC,cA7GA,wBA6GA;AACA;AACA,wEADA,CAEA;;AACA;AACA;AACA5D,6DADA;AAEAC;AAFA;AAIA;AACA,SATA,CAUA;;;AACA;AACA;AACA4D;AACAA;AACA;AACAC;AACA;AACA;;AACA;AACA,OApBA,CAoBA;AACA;AACA9D,2DADA;AAEAC;AAFA;AAIA;AACA,KAxIA;AAyIA8D,WAzIA,qBAyIA;AAAA;;AACA;AACA;AACA;;AACA;AACA;AACA;AACA;;AACA;AACA;AACA,OAFA;AAGA,KApJA;AAqJA;AACAC,gBAtJA,0BAsJA;AAAA;;AACA;AACA;AACAC,oCACAvB,IADA,CACA;AAAA;AAAA,SADA,EAEAA,IAFA,CAEA;AACA;AACA;AACAwB;AACAA;AACAA;AACA,SARA;AASA,OAVA,MAUA;AACA;AACAA;AACAA;AACAA;AACAA;AACA;AACA;AAzKA;AApHA","names":["name","props","message","type","required","payload","components","ElRate","data","renderDom","showConversationList","relayMessage","selectedConversation","messageSelected","computed","mapState","currentConversation","currentUserProfile","isShowConversationList","rate","imageUrl","percentage","faceUrl","date","fileSize","from","avatar","currentConversationType","isMine","contentList","methods","translateCustomMessage","videoPayload","onImageLoaded","event","handlePreview","url","flag","toFixed","number","showGroupMemberProfile","getGroupMemberProfile","groupID","userIDList","then","member","messageClick","showMergerMessage","cancel","getList","value","messageRelay","toUserId","to","conversationType","priority","mergerHandler","videoError","e","play","audio","promise","tryPlayAMR","script","firstScript","playAMR","downloadFile","fetch","a"],"sourceRoot":"src/components/message/merger-message","sources":["mergerMessage-item.vue"],"sourcesContent":["<template>\n    <div class=\"message-wrapper col-2\">\n        <div class=\"content-wrapper\">\n<!--文本消息-->\n            <div class=\"message-container\" v-if=\"message.type === 'TIMTextElem'\">\n                <div class=\"text-message\" v-for=\"(item, index) in contentList\" :key=\"index\">\n                    <span  :key=\"index\" v-if=\"item.name === 'text'\">{{ item.text }}</span>\n                    <img v-else-if=\"item.name === 'img'\" :src=\"item.src\" width=\"20px\" height=\"20px\" :key=\"index\"/>\n                </div>\n            </div>\n<!--图片消息-->\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMImageElem'\">\n                <img class=\"image-element\" :src=\"payload.imageInfoArray[0].url\" @load=\"onImageLoaded\" @click=\"handlePreview()\" />\n            </div>\n<!--文件消息-->\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMFileElem'\">\n                <div class=\"file-element-wrapper\" title=\"单击下载\" @click=\"downloadFile\">\n                    <div class=\"file-box\">\n                        <i class=\"el-icon-document file-icon\"></i>\n                        <div class=\"file-element\">\n                            <span class=\"file-name\">{{ payload.fileName }}</span>\n                            <span class=\"file-size\">{{ fileSize }}</span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n<!--表情消息-->\n\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMFaceElem'\">\n                <img :src=\"faceUrl\"/>\n            </div>\n<!--视频消息-->\n            <div class=\"message-container\" v-else-if=\"message.type === TIM.TYPES.MSG_VIDEO\">\n                <video\n                        :src=\"payload.videoUrl\"\n                        controls\n                        class=\"merger-video\"\n                        @error=\"videoError\"\n                ></video>\n            </div>\n<!--音频消息-->\n            <div class=\"sound-element-wrapper\"  v-else-if=\"message.type === TIM.TYPES.MSG_AUDIO\" title=\"单击播放\" @click=\"play\">\n                <i class=\"iconfont icon-voice\"></i>\n                {{ payload.second + '\"' }}\n            </div>\n <!--自定义消息-->\n            <div class=\"message-container\" v-else-if=\"message.type === 'TIMCustomElem'\">\n                <div class=\"custom-element-wrapper\">\n                    <div class=\"survey\"  v-if=\"this.payload.data === 'survey'\">\n                        <div class=\"title\">对IM DEMO的评分和建议</div>\n                        <el-rate\n                                v-model=\"rate\"\n                                disabled\n                                show-score\n                                text-color=\"#ff9900\"\n                                score-template=\"{value}\">\n                        </el-rate>\n                        <div class=\"suggestion\">{{this.payload.extension}}</div>\n                    </div>\n                    <span class=\"text\" title=\"您可以自行解析自定义消息\" v-else>\n                      <template >{{translateCustomMessage(this.payload)}}</template>\n                    </span>\n                </div>\n            </div>\n<!--合并的消息-->\n            <div class=\"message-container\"  @click=\"mergerHandler(message)\" v-else-if=\"message.type === TIM.TYPES.MSG_MERGER\">\n                <div class=\"merger-item\">\n                    <p class=\"merger-title\">{{payload.title}}</p>\n                    <p class=\"merger-text\" v-for=\"(item, index) in payload.abstractList\" :key=\"index\">\n                        {{item}}\n                    </p>\n                </div>\n            </div>\n        </div>\n\n    </div>\n</template>\n\n<script>\n  import { mapState } from 'vuex'\n  import { decodeText } from '../../../utils/decodeText'\n  import { getFullDate } from '../../../utils/date'\n  import { Rate } from 'element-ui'\n\n  export default {\n    name: 'MessageItem',\n    props: {\n      message: {\n        type: Object,\n        required: true\n      },\n      payload: {\n        type: Object,\n        required: true\n      },\n\n    },\n    components: {\n      ElRate: Rate,\n    },\n    data() {\n      return {\n        renderDom: [],\n        showConversationList: false,\n        relayMessage: {},\n        selectedConversation: [],\n        messageSelected:[],\n      }\n    },\n    computed: {\n      ...mapState({\n        currentConversation: state => state.conversation.currentConversation,\n        currentUserProfile: state => state.user.currentUserProfile,\n        isShowConversationList: state => state.conversation.isShowConversationList,\n\n      }),\n      // 自定义消息\n      rate() {\n        return parseInt(this.payload.description)\n      },\n      // 图片消息\n      imageUrl() {\n        const url = this.payload.imageInfoArray[0].imageUrl\n        if (typeof url !== 'string') {\n          return ''\n        }\n        return url.slice(0, 2) === '//' ? `https:${url}` : url\n      },\n      // showProgressBar() {\n      //   return this.$parent.message.status === 'unSend'\n      // },\n      percentage() {\n        return Math.floor((this.$parent.message.progress || 0) * 100)\n      },\n      // 表情消息\n      faceUrl() {\n        let name = ''\n        if (this.payload.data.indexOf('@2x') > 0) {\n          name = this.payload.data\n        } else {\n          name = this.payload.data + '@2x'\n        }\n        return `https://web.sdk.qcloud.com/im/assets/face-elem/${name}.png`\n      },\n      // 时间换算\n      date() {\n        return getFullDate(new Date(this.message.time * 1000))\n      },\n\n      // 文件消息大小\n      fileSize() {\n        const size = this.payload.fileSize\n        if (size > 1024) {\n          if (size / 1024 > 1024) {\n            return `${this.toFixed(size / 1024 / 1024)} Mb`\n          }\n          return `${this.toFixed(size / 1024)} Kb`\n        }\n        return `${this.toFixed(size)}B`\n      },\n      // 消息昵称\n      from() {\n        const isC2C = this.currentConversation.type === this.TIM.TYPES.CONV_C2C\n        // 自己发送的用昵称渲染\n        if (this.isMine) {\n          return  this.currentUserProfile.nick || this.currentUserProfile.userID\n        }\n        // 1. C2C 的消息体中还无 nick / avatar 字段，需从 conversation.userProfile 中获取\n        if (isC2C) {\n          return (\n            this.currentConversation.userProfile.nick ||\n            this.currentConversation.userProfile.userID\n          )\n        }\n        // 2. 群组消息，用消息体中的 nick 渲染。nameCard暂时支持不完善\n        return this.message.nameCard ||  this.message.nick || this.message.from\n      },\n      avatar() {\n        if (this.currentConversation.type === 'C2C') {\n          return this.isMine\n            ? this.currentUserProfile.avatar\n            : this.currentConversation.userProfile.avatar\n        } else if (this.currentConversation.type === 'GROUP') {\n          return this.isMine\n            ? this.currentUserProfile.avatar\n            : this.message.avatar\n        } else {\n          return ''\n        }\n      },\n      currentConversationType() {\n        return this.currentConversation.type\n      },\n      isMine() {\n        return this.message.flow === 'out'\n      },\n      contentList() {\n        return decodeText(this.payload)\n      },\n    },\n    methods: {\n      // 自定义消息解析\n      translateCustomMessage(payload) {\n        let videoPayload = {}\n        try{\n          videoPayload = JSON.parse(payload.data)\n        } catch(e) {\n          videoPayload = {}\n        }\n        if (payload.data === 'group_create') {\n          return `${payload.extension}`\n        }\n        if (videoPayload.roomId) {\n          videoPayload.roomId = videoPayload.roomId.toString()\n          videoPayload.isFromGroupLive = 1\n          return videoPayload\n        }\n        if(payload.text) {\n          return payload.text\n        }else{\n          return '[自定义消息]'\n        }\n      },\n      // 图片消息\n      onImageLoaded(event) {\n        this.$bus.$emit('image-loaded', event)\n      },\n      handlePreview() {\n        this.$bus.$emit('image-preview', {\n          url: this.payload.imageInfoArray[0].url,\n          flag: true\n        })\n      },\n      toFixed(number, precision = 2) {\n        return number.toFixed(precision)\n      },\n      showGroupMemberProfile(event) {\n        this.tim\n          .getGroupMemberProfile({\n            groupID: this.message.to,\n            userIDList: [this.message.from]\n          })\n          .then(({ data: { memberList } }) => {\n            if (memberList[0]) {\n              this.$bus.$emit('showMemberProfile', { event, member: memberList[0] })\n            }\n          })\n      },\n      messageClick(message) {\n        this.$store.commit('showConversationList', false)\n        this.showConversationList = true\n        this.relayMessage = message   // 需要深拷贝吗？\n      },\n      showMergerMessage() {\n        this.$bus.$emit('mergerMessage', true)\n      },\n      cancel() {\n        this.showConversationList = false\n      },\n      getList(value) {\n        this.selectedConversation = value\n      },\n      messageRelay() {\n        let type = ''\n        let toUserId = ''\n        this.selectedConversation.forEach((item) => {\n          if(item.indexOf(this.TIM.TYPES.CONV_C2C) !== -1) {\n            type = this.TIM.TYPES.CONV_C2C\n            toUserId = item.substring(3,item.length)\n          }\n          if(item.indexOf(this.TIM.TYPES.CONV_GROUP) !== -1) {\n            type = this.TIM.TYPES.CONV_GROUP\n            toUserId = item.substring(5,item.length)\n          }\n          const message = this.tim.createForwardMessage({\n            to: toUserId,\n            conversationType: type,\n            payload: this.relayMessage,\n            priority: this.TIM.TYPES.MSG_PRIORITY_NORMAL\n          })\n          this.tim.sendMessage(message).catch(imError => {\n            this.$store.commit('showMessage', {\n              message: imError.message,\n              type: 'error'\n            })\n          })\n          this.showConversationList = false\n        })\n      },\n      // 合并的消息\n      mergerHandler(message) {\n        this.$store.commit('setMergerMessage', message)\n        // this.$bus.$emit('mergerMessage', message)\n      },\n      // 视频消息\n      videoError(e) {\n        this.$store.commit('showMessage', { type: 'error', message: '视频出错，错误原因：' + e.target.error.message })\n      },\n      // 音频消息\n      play() {\n        // 目前移动端的语音消息采用 aac 格式，以前用 amr 格式。默认先用 audio 标签播放，若无法播放则尝试 amr 格式播放。\n        const audio = document.createElement('audio')\n        audio.addEventListener('error', this.tryPlayAMR) // 播放出错，则尝试使用 AMR 播放\n        audio.src = this.payload.url\n        const promise = audio.play()\n        if (promise) {\n          promise.catch(() => {})\n        }\n      },\n      tryPlayAMR() {\n        try {\n          const isIE = /MSIE|Trident|Edge/.test(window.navigator.userAgent)\n          // amr 播放组件库在 IE 不支持\n          if (isIE) {\n            this.$store.commit('showMessage', {\n              message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n              type: 'warning'\n            })\n            return\n          }\n          // 动态插入 amr 播放组件库\n          if (!window.BenzAMRRecorder) {\n            const script = document.createElement('script')\n            script.addEventListener('load', this.playAMR)\n            script.src = './BenzAMRRecorder.js'\n            const firstScript = document.getElementsByTagName('script')[0]\n            firstScript.parentNode.insertBefore(script, firstScript)\n            return\n          }\n          this.playAMR()\n        } catch (error) {\n          this.$store.commit('showMessage', {\n            message: '您的浏览器不支持该格式的语音消息播放，请尝试更换浏览器，建议使用：谷歌浏览器',\n            type: 'warning'\n          })\n        }\n      },\n      playAMR() {\n        if (!this.amr && window.BenzAMRRecorder) {\n          this.amr = new window.BenzAMRRecorder()\n        }\n        if (this.amr.isInit()) {\n          this.amr.play()\n          return\n        }\n        this.amr.initWithUrl(this.url).then(() => {\n          this.amr.play()\n        })\n      },\n      // 文件消息\n      downloadFile() {\n        // 浏览器支持fetch则用blob下载，避免浏览器点击a标签，跳转到新页面预览的行为\n        if (window.fetch) {\n          fetch(this.payload.fileUrl)\n            .then(res => res.blob())\n            .then(blob => {\n              let a = document.createElement('a')\n              let url = window.URL.createObjectURL(blob)\n              a.href = url\n              a.download = this.payload.fileName\n              a.click()\n            })\n        } else {\n          let a = document.createElement('a')\n          a.href = this.payload.fileUrl\n          a.target = '_blank'\n          a.download = this.filename\n          a.click()\n        }\n      }\n    }\n  }\n</script>\n\n<style lang=\"stylus\" scoped>\n    .conversation-container {\n        position absolute\n        top 0\n        left 0px\n        width 100%\n        background-color #fff\n        z-index 999\n    }\n    .conversation-list-btn {\n        width 140px\n        display flex\n        float right\n        margin 10px 0\n        .conversation-btn {\n            cursor pointer\n            padding 6px 12px\n            background #00A4FF\n            color #ffffff\n            font-size 14px\n            border-radius 20px\n            margin-left 13px\n        }\n    }\n    .message-wrapper {\n        margin: 5px 5px 10px 5px;\n        .content-wrapper {\n            display: flex\n            align-items: center\n            .message-container {\n                width 100%\n                .text-message {\n                    padding 3px 10px\n                }\n                .image-element {\n                    max-height 300px\n                }\n                .merger-item {\n                    border 1px solid #DEDEDE\n                    background-color #ffffff\n                    padding 0 10px\n                    border-radius 6px\n                    .merger-title {\n                        font-size 15px\n                        max-width 180px\n                        overflow hidden;\n                        text-overflow ellipsis;\n                        white-space nowrap;\n                    }\n                    .merger-text {\n                        color #B3B3B3\n                        margin 10px 0\n                        font-size 13px\n                        max-width 280px\n                        overflow hidden;\n                        text-overflow ellipsis;\n                        white-space nowrap;\n                    }\n                }\n            }\n        }\n    }\n\n    .group-layout, .c2c-layout, .system-layout {\n        display: flex;\n\n        .col-1 {\n            .avatar {\n                width: 56px;\n                height: 56px;\n                border-radius: 50%;\n                box-shadow: 0 5px 10px 0 rgba(0, 0, 0, 0.1);\n            }\n        }\n\n        .group-member-avatar {\n            cursor: pointer;\n        }\n\n        .col-2 {\n            display: flex;\n            flex-direction: column;\n            // max-width 50% // 此设置可以自适应宽度，目前由bubble限制\n        }\n\n        .col-3 {\n            width: 30px;\n        }\n\n        &.position-left {\n            .col-2 {\n                align-items: flex-start;\n            }\n        }\n\n        &.position-right {\n            flex-direction: row-reverse;\n\n            .col-2 {\n                align-items: flex-end;\n            }\n        }\n\n        &.position-center {\n            justify-content: center;\n        }\n    }\n\n    .c2c-layout {\n        .col-2 {\n            .base {\n                margin-top: 3px;\n            }\n        }\n    }\n\n    .group-layout {\n        .col-2 {\n            .chat-bubble {\n                margin-top: 5px;\n                outline none\n            }\n        }\n    }\n    .right {\n        display: flex;\n        flex-direction: row-reverse;\n    }\n\n    .left {\n        display: flex;\n        flex-direction: row;\n    }\n\n    .base {\n        color: $secondary;\n        font-size: 12px;\n    }\n\n    .name {\n        padding: 0 4px;\n        max-width: 100px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n    }\n    .merger-video {\n        width 100%\n        max-height 300px\n    }\n    .file-box {\n        display: flex;\n    }\n    .file-icon {\n        font-size: 40px !important;\n    }\n    .file-element {\n        display: flex;\n        flex-direction: column;\n        margin-left: 12px;\n    }\n    .file-size {\n        font-size: 12px;\n        padding-top 5px\n    }\n\n    .text\n    font-weight bold\n    .title\n        font-size 16px\n        font-weight 600\n        padding-bottom 10px\n    .survey\n        background-color white\n        color black\n        padding 20px\n        display flex\n        flex-direction column\n    .suggestion\n        padding-top 10px\n        font-size 14px\n    .sound-element-wrapper {\n        background-color #fff\n        padding 2px 13px\n        cursor pointer\n        border-radius 3px\n    }\n</style>\n"]}]}